'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _cheerio = require('cheerio');

var _moment = require('moment');

var _moment2 = _interopRequireDefault(_moment);

var _ramda = require('ramda');

var _request = require('../request');

var _request2 = _interopRequireDefault(_request);

var _routes = require('../routes');

var _routes2 = _interopRequireDefault(_routes);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var toArray = function toArray(element) {
  return element.toArray();
};

var hasNextPage = function hasNextPage(selector) {
  return (0, _ramda.not)(selector('.pagination').children().last().hasClass('disabled'));
};

var hasOrders = function hasOrders(selector) {
  return (0, _ramda.pipe)(function (selector) {
    return selector('ol.orders-list li.order');
  }, _ramda.length, (0, _ramda.gt)(_ramda.__, 0));
};

var getCustomerName = function getCustomerName(selector, element) {
  return selector('.store span.store-name', element).text();
};

var getOrderNumber = function getOrderNumber(selector, element) {
  return (0, _ramda.replace)('Pedido ', '', selector('a.order-title', element).text());
};

var getOrderStatus = (0, _ramda.pipe)(function (selector, element) {
  return selector('.alert', element).text();
}, (0, _ramda.cond)([[(0, _ramda.test)(/confirmar o recebimento/), (0, _ramda.always)('shipping')], [(0, _ramda.test)(/cancelou este pedido/), (0, _ramda.always)('canceled')], [(0, _ramda.test)(/finalizada com sucesso/), (0, _ramda.always)('finished')], [(0, _ramda.test)(/finalizou o pedido/), (0, _ramda.always)('finished')], [(0, _ramda.test)(/efetuar o pagamento/), (0, _ramda.always)('waiting_payment')], [(0, _ramda.test)(/confirmação do pagamento/), (0, _ramda.always)('processing')]]));

var getOrderDate = function getOrderDate(selector, element) {
  return (0, _moment2.default)(selector('.details time', element).text(), 'DD-MM-YYYY').format('YYYY-MM-DD');
};

var toFixed = (0, _ramda.curry)(function (number, precision) {
  return number.toFixed(precision);
});

var getOrderValue = (0, _ramda.pipe)(function (selector, element) {
  return (0, _ramda.replace)(/[^0-9]/g, '', selector('span.price', element).text());
}, parseInt, (0, _ramda.divide)(_ramda.__, 100), toFixed(_ramda.__, 2));

var getOrderInfo = (0, _ramda.curry)(function (selector, element) {
  return {
    customer_name: getCustomerName(selector, element),
    order_number: getOrderNumber(selector, element),
    date: getOrderDate(selector, element),
    value: getOrderValue(selector, element),
    status: getOrderStatus(selector, element)
  };
});

var scrap = (0, _ramda.ifElse)(hasOrders, function (selector) {
  return (0, _ramda.map)(getOrderInfo(selector), toArray(selector('ol.orders-list li.order')));
}, function () {
  return [];
});

var _list = (0, _ramda.curry)(function (session, page) {
  var next = function next(selector) {
    return _list(session, (0, _ramda.inc)(page)).then((0, _ramda.concat)(scrap(selector)));
  };

  var scrapRecursive = (0, _ramda.ifElse)(hasNextPage, next, scrap);

  return _request2.default.get(session, _routes2.default.order.list(page), {}).then(_cheerio.load).then(scrapRecursive);
});

exports.default = {
  list: function list(session) {
    return function () {
      return _list(session, 1);
    };
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXNvdXJjZXMvb3JkZXIuanMiXSwibmFtZXMiOlsidG9BcnJheSIsImVsZW1lbnQiLCJoYXNOZXh0UGFnZSIsInNlbGVjdG9yIiwiY2hpbGRyZW4iLCJsYXN0IiwiaGFzQ2xhc3MiLCJoYXNPcmRlcnMiLCJnZXRDdXN0b21lck5hbWUiLCJ0ZXh0IiwiZ2V0T3JkZXJOdW1iZXIiLCJnZXRPcmRlclN0YXR1cyIsImdldE9yZGVyRGF0ZSIsImZvcm1hdCIsInRvRml4ZWQiLCJudW1iZXIiLCJwcmVjaXNpb24iLCJnZXRPcmRlclZhbHVlIiwicGFyc2VJbnQiLCJnZXRPcmRlckluZm8iLCJjdXN0b21lcl9uYW1lIiwib3JkZXJfbnVtYmVyIiwiZGF0ZSIsInZhbHVlIiwic3RhdHVzIiwic2NyYXAiLCJsaXN0Iiwic2Vzc2lvbiIsInBhZ2UiLCJuZXh0IiwidGhlbiIsInNjcmFwUmVjdXJzaXZlIiwiZ2V0Iiwib3JkZXIiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOztBQUNBOzs7O0FBQ0E7O0FBaUJBOzs7O0FBQ0E7Ozs7OztBQUVBLElBQU1BLFVBQVUsU0FBVkEsT0FBVTtBQUFBLFNBQVdDLFFBQVFELE9BQVIsRUFBWDtBQUFBLENBQWhCOztBQUVBLElBQU1FLGNBQWMsU0FBZEEsV0FBYztBQUFBLFNBQ2xCLGdCQUFJQyxTQUFTLGFBQVQsRUFBd0JDLFFBQXhCLEdBQW1DQyxJQUFuQyxHQUEwQ0MsUUFBMUMsQ0FBbUQsVUFBbkQsQ0FBSixDQURrQjtBQUFBLENBQXBCOztBQUdBLElBQU1DLFlBQVksU0FBWkEsU0FBWTtBQUFBLFNBQVksaUJBQzFCO0FBQUEsV0FBWUosU0FBUyx5QkFBVCxDQUFaO0FBQUEsR0FEMEIsaUJBRzFCLDBCQUFPLENBQVAsQ0FIMEIsQ0FBWjtBQUFBLENBQWxCOztBQU1BLElBQU1LLGtCQUFrQixTQUFsQkEsZUFBa0IsQ0FBQ0wsUUFBRCxFQUFXRixPQUFYO0FBQUEsU0FDdEJFLFNBQVMsd0JBQVQsRUFBbUNGLE9B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LFdBRHFCLEVBRXJCMkIsSUFGcUIsRUFHckJKLEtBSHFCLENBQXZCOztBQU1BLFNBQU8sa0JBQVFPLEdBQVIsQ0FBWUwsT0FBWixFQUFxQixpQkFBT00sS0FBUCxDQUFhUCxJQUFiLENBQWtCRSxJQUFsQixDQUFyQixFQUE4QyxFQUE5QyxFQUNKRSxJQURJLGdCQUVKQSxJQUZJLENBRUNDLGNBRkQsQ0FBUDtBQUdELENBZFksQ0FBYjs7a0JBZ0JlO0FBQ2JMLFFBQU07QUFBQSxXQUFXO0FBQUEsYUFBTUEsTUFBS0MsT0FBTCxFQUFjLENBQWQsQ0FBTjtBQUFBLEtBQVg7QUFBQTtBQURPLEMiLCJmaWxlIjoib3JkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBsb2FkIH0gZnJvbSAnY2hlZXJpbydcbmltcG9ydCBtb21lbnQgZnJvbSAnbW9tZW50J1xuaW1wb3J0IHtcbiAgYWx3YXlzLFxuICBjb25jYXQsXG4gIGNvbmQsXG4gIGN1cnJ5LFxuICBkaXZpZGUsXG4gIGd0LFxuICBpZkVsc2UsXG4gIGluYyxcbiAgbGVuZ3RoLFxuICBtYXAsXG4gIG5vdCxcbiAgcGlwZSxcbiAgcmVwbGFjZSxcbiAgdGVzdCxcbiAgX18sXG59IGZyb20gJ3JhbWRhJ1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAnLi4vcmVxdWVzdCdcbmltcG9ydCByb3V0ZXMgZnJvbSAnLi4vcm91dGVzJ1xuXG5jb25zdCB0b0FycmF5ID0gZWxlbWVudCA9PiBlbGVtZW50LnRvQXJyYXkoKVxuXG5jb25zdCBoYXNOZXh0UGFnZSA9IHNlbGVjdG9yID0+XG4gIG5vdChzZWxlY3RvcignLnBhZ2luYXRpb24nKS5jaGlsZHJlbigpLmxhc3QoKS5oYXNDbGFzcygnZGlzYWJsZWQnKSlcblxuY29uc3QgaGFzT3JkZXJzID0gc2VsZWN0b3IgPT4gcGlwZShcbiAgICBzZWxlY3RvciA9PiBzZWxlY3Rvcignb2wub3JkZXJzLWxpc3QgbGkub3JkZXInKSxcbiAgICBsZW5ndGgsXG4gICAgZ3QoX18sIDApLFxuICApXG5cbmNvbnN0IGdldEN1c3RvbWVyTmFtZSA9IChzZWxlY3RvciwgZWxlbWVudCkgPT5cbiAgc2VsZWN0b3IoJy5zdG9yZSBzcGFuLnN0b3JlLW5hbWUnLCBlbGVtZW50KS50ZXh0KClcblxuY29uc3QgZ2V0T3JkZXJOdW1iZXIgPSAoc2VsZWN0b3IsIGVsZW1lbnQpID0+XG4gIHJlcGxhY2UoJ1BlZGlkbyAnLCAnJywgc2VsZWN0b3IoJ2Eub3JkZXItdGl0bGUnLCBlbGVtZW50KS50ZXh0KCkpXG5cbmNvbnN0IGdldE9yZGVyU3RhdHVzID0gcGlwZShcbiAgKHNlbGVjdG9yLCBlbGVtZW50KSA9PiBzZWxlY3RvcignLmFsZXJ0JywgZWxlbWVudCkudGV4dCgpLFxuICBjb25kKFtcbiAgICBbdGVzdCgvY29uZmlybWFyIG8gcmVjZWJpbWVudG8vKSwgYWx3YXlzKCdzaGlwcGluZycpXSxcbiAgICBbdGVzdCgvY2FuY2Vsb3UgZXN0ZSBwZWRpZG8vKSwgYWx3YXlzKCdjYW5jZWxlZCcpXSxcbiAgICBbdGVzdCgvZmluYWxpemFkYSBjb20gc3VjZXNzby8pLCBhbHdheXMoJ2ZpbmlzaGVkJyldLFxuICAgIFt0ZXN0KC9maW5hbGl6b3UgbyBwZWRpZG8vKSwgYWx3YXlzKCdmaW5pc2hlZCcpXSxcbiAgICBbdGVzdCgvZWZldHVhciBvIHBhZ2FtZW50by8pLCBhbHdheXMoJ3dhaXRpbmdfcGF5bWVudCcpXSxcbiAgICBbdGVzdCgvY29uZmlybWHDp8OjbyBkbyBwYWdhbWVudG8vKSwgYWx3YXlzKCdwcm9jZXNzaW5nJyldLFxuICBdKSxcbilcblxuY29uc3QgZ2V0T3JkZXJEYXRlID0gKHNlbGVjdG9yLCBlbGVtZW50KSA9PlxuICBtb21lbnQoXG4gICAgc2VsZWN0b3IoJy5kZXRhaWxzIHRpbWUnLCBlbGVtZW50KS50ZXh0KCksXG4gICAgJ0RELU1NLVlZWVknLFxuICApLmZvcm1hdCgnWVlZWS1NTS1ERCcpXG5cbmNvbnN0IHRvRml4ZWQgPSBjdXJyeSgobnVtYmVyLCBwcmVjaXNpb24pID0+IG51bWJlci50b0ZpeGVkKHByZWNpc2lvbikpXG5cbmNvbnN0IGdldE9yZGVyVmFsdWUgPSBwaXBlKFxuICAoc2VsZWN0b3IsIGVsZW1lbnQpID0+XG4gICAgcmVwbGFjZSgvW14wLTldL2csICcnLCBzZWxlY3Rvcignc3Bhbi5wcmljZScsIGVsZW1lbnQpLnRleHQoKSksXG4gIHBhcnNlSW50LFxuICBkaXZpZGUoX18sIDEwMCksXG4gIHRvRml4ZWQoX18sIDIpLFxuKVxuXG5jb25zdCBnZXRPcmRlckluZm8gPSBjdXJyeSgoc2VsZWN0b3IsIGVsZW1lbnQpID0+ICh7XG4gIGN1c3RvbWVyX25hbWU6IGdldEN1c3RvbWVyTmFtZShzZWxlY3RvciwgZWxlbWVudCksXG4gIG9yZGVyX251bWJlcjogZ2V0T3JkZXJOdW1iZXIoc2VsZWN0b3IsIGVsZW1lbnQpLFxuICBkYXRlOiBnZXRPcmRlckRhdGUoc2VsZWN0b3IsIGVsZW1lbnQpLFxuICB2YWx1ZTogZ2V0T3JkZXJWYWx1ZShzZWxlY3RvciwgZWxlbWVudCksXG4gIHN0YXR1czogZ2V0T3JkZXJTdGF0dXMoc2VsZWN0b3IsIGVsZW1lbnQpLFxufSkpXG5cbmNvbnN0IHNjcmFwID0gaWZFbHNlKFxuICAgIGhhc09yZGVycyxcbiAgICBzZWxlY3RvciA9PiBtYXAoXG4gICAgICBnZXRPcmRlckluZm8oc2VsZWN0b3IpLFxuICAgICAgdG9BcnJheShzZWxlY3Rvcignb2wub3JkZXJzLWxpc3QgbGkub3JkZXInKSksXG4gICAgKSxcbiAgICAoKSA9PiBbXSxcbiAgKVxuXG5jb25zdCBsaXN0ID0gY3VycnkoKHNlc3Npb24sIHBhZ2UpID0+IHtcbiAgY29uc3QgbmV4dCA9IHNlbGVjdG9yID0+XG4gICAgbGlzdChzZXNzaW9uLCBpbmMocGFnZSkpXG4gICAgICAudGhlbihjb25jYXQoc2NyYXAoc2VsZWN0b3IpKSlcblxuICBjb25zdCBzY3JhcFJlY3Vyc2l2ZSA9IGlmRWxzZShcbiAgICBoYXNOZXh0UGFnZSxcbiAgICBuZXh0LFxuICAgIHNjcmFwLFxuICApXG5cbiAgcmV0dXJuIHJlcXVlc3QuZ2V0KHNlc3Npb24sIHJvdXRlcy5vcmRlci5saXN0KHBhZ2UpLCB7fSlcbiAgICAudGhlbihsb2FkKVxuICAgIC50aGVuKHNjcmFwUmVjdXJzaXZlKVxufSlcblxuZXhwb3J0IGRlZmF1bHQge1xuICBsaXN0OiBzZXNzaW9uID0+ICgpID0+IGxpc3Qoc2Vzc2lvbiwgMSksXG59XG4iXX0=